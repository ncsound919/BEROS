# -*- coding: utf-8 -*-
import pygame
import math
import random
import sys

# Initialize Pygame
pygame.init()

# Constants
SCREEN_WIDTH = 800
SCREEN_HEIGHT = 600
FPS = 60
GRAVITY = 0.3
SLINGSHOT_POS = (100, 500)
MAX_PULL_DISTANCE = 100

# Colors (Urban theme)
BLACK = (0, 0, 0)
WHITE = (255, 255, 255)
GRAY = (128, 128, 128)
DARK_GRAY = (64, 64, 64)
RED = (255, 0, 0)
GREEN = (0, 255, 0)
BLUE = (0, 0, 255)
YELLOW = (255, 255, 0)
PURPLE = (128, 0, 128)
ORANGE = (255, 165, 0)

# Set up the display
screen = pygame.display.set_mode((SCREEN_WIDTH, SCREEN_HEIGHT))
pygame.display.set_caption("Urban Slingshot Fury")
clock = pygame.time.Clock()
font = pygame.font.SysFont(None, 36)

class Projectile(pygame.sprite.Sprite):
    def __init__(self, x, y, vel_x, vel_y):
        super().__init__()
        self.image = pygame.Surface((10, 10))
        self.image.fill(YELLOW)
        self.rect = self.image.get_rect()
        self.rect.center = (x, y)
        self.vel_x = vel_x
        self.vel_y = vel_y
        self.launched = True

    def update(self):
        if self.launched:
            self.vel_y += GRAVITY
            self.rect.x += self.vel_x
            self.rect.y += self.vel_y

            # Remove if off screen
            if self.rect.right < 0 or self.rect.left > SCREEN_WIDTH or self.rect.bottom > SCREEN_HEIGHT:
                self.kill()

class Target(pygame.sprite.Sprite):
    def __init__(self, x, y):
        super().__init__()
        self.image = pygame.Surface((40, 40))
        self.image.fill(RED)
        self.rect = self.image.get_rect()
        self.rect.center = (x, y)
        self.health = 2

    def take_damage(self):
        self.health -= 1
        if self.health <= 0:
            self.kill()
            return True
        return False

class Slingshot:
    def __init__(self):
        self.pos = SLINGSHOT_POS
        self.pull_start = None
        self.pull_vector = (0, 0)

    def start_aim(self, mouse_pos):
        self.pull_start = mouse_pos

    def update_aim(self, mouse_pos):
        if self.pull_start:
            dx = self.pull_start[0] - mouse_pos[0]
            dy = self.pull_start[1] - mouse_pos[1]
            distance = math.sqrt(dx**2 + dy**2)
            if distance > MAX_PULL_DISTANCE:
                dx = dx / distance * MAX_PULL_DISTANCE
                dy = dy / distance * MAX_PULL_DISTANCE
            self.pull_vector = (dx, dy)

    def release(self):
        if self.pull_start:
            vel_x = self.pull_vector[0] * 0.1
            vel_y = self.pull_vector[1] * 0.1
            self.pull_start = None
            self.pull_vector = (0, 0)
            return vel_x, vel_y
        return 0, 0

    def draw(self, screen):
        # Draw slingshot base
        pygame.draw.rect(screen, DARK_GRAY, (self.pos[0] - 5, self.pos[1], 10, 50))
        pygame.draw.circle(screen, GRAY, self.pos, 20)

        # Draw aim line
        if self.pull_start:
            pygame.draw.line(screen, WHITE, self.pos,
                           (self.pos[0] + self.pull_vector[0], self.pos[1] + self.pull_vector[1]), 3)

def create_targets():
    targets = pygame.sprite.Group()
    for i in range(5):
        x = random.randint(400, 700)
        y = random.randint(100, 400)
        targets.add(Target(x, y))
    return targets

def main():
    slingshot = Slingshot()
    projectiles = pygame.sprite.Group()
    targets = create_targets()
    score = 0
    projectiles_left = 10
    game_over = False

    running = True
    while running:
        clock.tick(FPS)

        for event in pygame.event.get():
            if event.type == pygame.QUIT:
                running = False
            elif event.type == pygame.MOUSEBUTTONDOWN and not game_over:
                if event.button == 1:  # Left click
                    slingshot.start_aim(event.pos)
            elif event.type == pygame.MOUSEBUTTONUP and not game_over:
                if event.button == 1:
                    vel_x, vel_y = slingshot.release()
                    if projectiles_left > 0:
                        projectile = Projectile(slingshot.pos[0], slingshot.pos[1], vel_x, vel_y)
                        projectiles.add(projectile)
                        projectiles_left -= 1

        if not game_over:
            slingshot.update_aim(pygame.mouse.get_pos())
            projectiles.update()

            # Check collisions
            for projectile in projectiles:
                hit_targets = pygame.sprite.spritecollide(projectile, targets, False)
                for target in hit_targets:
                    if target.take_damage():
                        score += 100
                    projectile.kill()
                    break

            # Check game over
            if projectiles_left <= 0 and len(projectiles) == 0:
                game_over = True
            elif len(targets) == 0:
                game_over = True

        # Draw
        screen.fill(BLACK)  # Night sky

        # Draw city background
        pygame.draw.rect(screen, DARK_GRAY, (0, SCREEN_HEIGHT - 100, SCREEN_WIDTH, 100))  # Ground
        for i in range(5):
            pygame.draw.rect(screen, GRAY, (i * 150 + 50, SCREEN_HEIGHT - 200 - i * 50, 100, 200 + i * 50))  # Buildings

        slingshot.draw(screen)
        projectiles.draw(screen)
        targets.draw(screen)

        # UI
        score_text = font.render(f"Score: {score}", True, WHITE)
        projectiles_text = font.render(f"Projectiles: {projectiles_left}", True, WHITE)
        targets_text = font.render(f"Targets: {len(targets)}", True, WHITE)
        screen.blit(score_text, (10, 10))
        screen.blit(projectiles_text, (10, 50))
        screen.blit(targets_text, (10, 90))

        if game_over:
            if len(targets) == 0:
                result_text = font.render("You Win!", True, GREEN)
            else:
                result_text = font.render("Game Over", True, RED)
            screen.blit(result_text, (SCREEN_WIDTH // 2 - 100, SCREEN_HEIGHT // 2 - 50))
            final_score_text = font.render(f"Final Score: {score}", True, WHITE)
            screen.blit(final_score_text, (SCREEN_WIDTH // 2 - 100, SCREEN_HEIGHT // 2))

        pygame.display.flip()

    pygame.time.wait(3000)
    pygame.quit()
    sys.exit()

if __name__ == "__main__":
    main()
