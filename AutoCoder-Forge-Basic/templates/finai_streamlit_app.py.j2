"""
FinAI Hub - Advanced Financial Analytics Frontend
Generated by AutoCoder

Template variables:
  - title: str (App title)
  - kronos_endpoint: str (API endpoint)
  - docsgpt_endpoint: str (API endpoint)
  - goose_endpoint: str (API endpoint)
  - laddr_endpoint: str (API endpoint)
  - vutuv_endpoint: str (API endpoint)
"""

import streamlit as st
import pandas as pd
import numpy as np
import plotly.graph_objects as go
import plotly.express as px
from plotly.subplots import make_subplots
import requests
import json
from datetime import datetime, timedelta
import time
import threading
import subprocess
import sys
import os

# Page configuration
st.set_page_config(
    page_title="{{ title }}",
    page_icon="üìà",
    layout="wide",
    initial_sidebar_state="expanded"
)

# Custom CSS for better styling
st.markdown("""
<style>
    .main-header {
        font-size: 2.5rem;
        font-weight: bold;
        color: #1f77b4;
        text-align: center;
        margin-bottom: 2rem;
    }
    .metric-card {
        background-color: #f0f2f6;
        padding: 1rem;
        border-radius: 0.5rem;
        border-left: 0.25rem solid #1f77b4;
    }
    .prediction-card {
        background-color: #e8f4f8;
        padding: 1rem;
        border-radius: 0.5rem;
        border-left: 0.25rem solid #17a2b8;
    }
    .sidebar-header {
        font-size: 1.25rem;
        font-weight: bold;
        margin-bottom: 1rem;
    }
</style>
""", unsafe_allow_html=True)

# Global variables for backend
BACKEND_RUNNING = False
BACKEND_PROCESS = None

def start_backend():
    """Start the FastAPI backend in a separate thread"""
    global BACKEND_RUNNING, BACKEND_PROCESS
    if not BACKEND_RUNNING:
        try:
            BACKEND_PROCESS = subprocess.Popen([sys.executable, "finai_backend.py"])
            time.sleep(3)  # Wait for startup
            BACKEND_RUNNING = True
            st.success("Backend started successfully!")
        except Exception as e:
            st.error(f"Failed to start backend: {e}")

def stop_backend():
    """Stop the backend process"""
    global BACKEND_RUNNING, BACKEND_PROCESS
    if BACKEND_RUNNING and BACKEND_PROCESS:
        BACKEND_PROCESS.terminate()
        BACKEND_PROCESS.wait()
        BACKEND_RUNNING = False
        st.info("Backend stopped.")

# API client functions
class FinAIClient:
    def __init__(self):
        self.kronos_url = "{{ kronos_endpoint }}"
        self.docsgpt_url = "{{ docsgpt_endpoint }}"
        self.goose_url = "{{ goose_endpoint }}"
        self.laddr_url = "{{ laddr_endpoint }}"
        self.vutuv_url = "{{ vutuv_endpoint }}"

    def get_kronos_prediction(self, data, pred_len=120):
        try:
            payload = {
                "historical_data": data,
                "prediction_length": pred_len,
                "temperature": 1.0,
                "top_p": 0.9,
                "sample_count": 1
            }
            response = requests.post(f"{self.kronos_url}/predict", json=payload, timeout=30)
            response.raise_for_status()
            return response.json()
        except Exception as e:
            st.error(f"Kronos prediction failed: {e}")
            return None

    def analyze_document(self, question, document_id=None):
        try:
            payload = {"question": question}
            if document_id:
                payload["document_id"] = document_id
            response = requests.post(f"{self.docsgpt_url}/query", json=payload, timeout=30)
            response.raise_for_status()
            return response.json()
        except Exception as e:
            st.error(f"Document analysis failed: {e}")
            return None

    def get_ladder_progress(self, user_id):
        try:
            response = requests.post(f"{self.laddr_url}/progress", json={"user_id": user_id}, timeout=10)
            response.raise_for_status()
            return response.json()
        except Exception as e:
            st.error(f"Ladder progress failed: {e}")
            return None

    def get_social_feed(self, user_id):
        try:
            response = requests.get(f"{self.vutuv_url}/feed/{user_id}", timeout=10)
            response.raise_for_status()
            return response.json()
        except Exception as e:
            st.error(f"Social feed failed: {e}")
            return None

# Initialize client
client = FinAIClient()

# Sidebar
st.sidebar.markdown('<div class="sidebar-header">FinAI Hub Control Panel</div>', unsafe_allow_html=True)

# Backend control
st.sidebar.subheader("Backend Status")
col1, col2 = st.sidebar.columns(2)
with col1:
    if st.button("Start Backend", type="primary"):
        start_backend()
with col2:
    if st.button("Stop Backend", type="secondary"):
        stop_backend()

backend_status = "Running" if BACKEND_RUNNING else "Stopped"
status_color = "üü¢" if BACKEND_RUNNING else "üî¥"
st.sidebar.write(f"Status: {status_color} {backend_status}")

# Navigation
st.sidebar.subheader("Navigation")
page = st.sidebar.radio("Go to", [
    "Dashboard",
    "Market Analysis",
    "Portfolio Management",
    "Document Analysis",
    "Social Network",
    "Investment Ladder",
    "Settings"
])

# Main content
st.markdown('<div class="main-header">{{ title }}</div>', unsafe_allow_html=True)

if page == "Dashboard":
    st.header("üìä Financial Analytics Dashboard")

    # Key metrics
    col1, col2, col3, col4 = st.columns(4)

    with col1:
        st.markdown('<div class="metric-card">', unsafe_allow_html=True)
        st.metric("Portfolio Value", "$125,430", "+2.5%")
        st.markdown('</div>', unsafe_allow_html=True)

    with col2:
        st.markdown('<div class="metric-card">', unsafe_allow_html=True)
        st.metric("Today's Return", "+$1,250", "+1.0%")
        st.markdown('</div>', unsafe_allow_html=True)

    with col3:
        st.markdown('<div class="metric-card">', unsafe_allow_html=True)
        st.metric("Risk Score", "6.2/10", "-0.3")
        st.markdown('</div>', unsafe_allow_html=True)

    with col4:
        st.markdown('<div class="metric-card">', unsafe_allow_html=True)
        st.metric("Predictions Accuracy", "78%", "+5%")
        st.markdown('</div>', unsafe_allow_html=True)

    # Market overview chart
    st.subheader("Market Overview")

    # Generate sample data
    dates = pd.date_range(start='2024-01-01', end=datetime.now(), freq='D')
    np.random.seed(42)
    prices = 100 + np.cumsum(np.random.randn(len(dates)) * 2)
    df = pd.DataFrame({'Date': dates, 'Price': prices})

    fig = px.line(df, x='Date', y='Price', title='S&P 500 Index')
    fig.update_layout(height=400)
    st.plotly_chart(fig, use_container_width=True)

    # Recent predictions
    st.subheader("Recent AI Predictions")

    if BACKEND_RUNNING:
        # Sample prediction data
        pred_data = [
            {"asset": "AAPL", "prediction": "Bullish", "confidence": 0.85, "timeframe": "1 Week"},
            {"asset": "TSLA", "prediction": "Bearish", "confidence": 0.72, "timeframe": "3 Days"},
            {"asset": "GOOGL", "prediction": "Neutral", "confidence": 0.55, "timeframe": "1 Month"}
        ]

        for pred in pred_data:
            st.markdown(f"""
            <div class="prediction-card">
                <strong>{pred['asset']}</strong>: {pred['prediction']}
                (Confidence: {pred['confidence']:.1%}, Timeframe: {pred['timeframe']})
            </div>
            """, unsafe_allow_html=True)
    else:
        st.warning("Start the backend to see AI predictions")

elif page == "Market Analysis":
    st.header("üìà Advanced Market Analysis")

    # Asset selection
    asset = st.selectbox("Select Asset", ["AAPL", "GOOGL", "MSFT", "TSLA", "AMZN"])

    # Time range
    col1, col2 = st.columns(2)
    with col1:
        start_date = st.date_input("Start Date", datetime.now() - timedelta(days=365))
    with col2:
        end_date = st.date_input("End Date", datetime.now())

    # Technical indicators
    st.subheader("Technical Analysis")

    # Generate sample OHLC data
    np.random.seed(42)
    n_days = (end_date - start_date).days
    dates = pd.date_range(start=start_date, end=end_date, freq='D')

    # Generate realistic OHLC data
    base_price = 150
    prices = base_price + np.cumsum(np.random.randn(len(dates)) * 3)

    ohlc_data = []
    for i, price in enumerate(prices):
        open_price = price + np.random.randn() * 2
        high = max(open_price, price + abs(np.random.randn()) * 5)
        low = min(open_price, price - abs(np.random.randn()) * 5)
        close = price + np.random.randn() * 2
        volume = np.random.randint(1000000, 10000000)

        ohlc_data.append({
            'date': dates[i],
            'open': round(open_price, 2),
            'high': round(high, 2),
            'low': round(low, 2),
            'close': round(close, 2),
            'volume': volume
        })

    df_ohlc = pd.DataFrame(ohlc_data)

    # Candlestick chart
    fig = go.Figure(data=[go.Candlestick(
        x=df_ohlc['date'],
        open=df_ohlc['open'],
        high=df_ohlc['high'],
        low=df_ohlc['low'],
        close=df_ohlc['close']
    )])

    fig.update_layout(
        title=f"{asset} Candlestick Chart",
        xaxis_title="Date",
        yaxis_title="Price",
        height=600
    )

    st.plotly_chart(fig, use_container_width=True)

    # AI Prediction
    st.subheader("AI Market Prediction")

    if st.button("Generate Prediction", type="primary"):
        if BACKEND_RUNNING:
            with st.spinner("Generating prediction..."):
                # Convert to format expected by Kronos
                hist_data = df_ohlc[['open', 'high', 'low', 'close', 'volume']].tail(400).to_dict('records')

                prediction = client.get_kronos_prediction(hist_data, pred_len=120)

                if prediction:
                    st.success("Prediction generated!")

                    # Display prediction results
                    pred_df = pd.DataFrame(prediction['predictions'])

                    fig_pred = px.line(pred_df, x=range(len(pred_df)), y=['open', 'high', 'low', 'close'],
                                      title="120-Point Price Prediction")
                    st.plotly_chart(fig_pred, use_container_width=True)

                    # Prediction metrics
                    col1, col2, col3 = st.columns(3)
                    with col1:
                        st.metric("Expected Return", "+5.2%", "vs market")
                    with col2:
                        st.metric("Volatility", "12.3%", "-2.1%")
                    with col3:
                        st.metric("Confidence", "78%", "+5%")
                else:
                    st.error("Failed to generate prediction")
        else:
            st.warning("Please start the backend first")

elif page == "Portfolio Management":
    st.header("üíº Portfolio Management")

    # Portfolio composition
    st.subheader("Portfolio Composition")

    portfolio_data = {
        'Asset': ['AAPL', 'GOOGL', 'MSFT', 'TSLA', 'Bonds', 'Cash'],
        'Value': [45000, 32000, 28000, 15000, 5000, 2430],
        'Weight': [36.0, 25.6, 22.4, 12.0, 4.0, 1.9],
        'Change': [2.1, -1.5, 3.2, -0.8, 0.5, 0.0]
    }

    df_portfolio = pd.DataFrame(portfolio_data)

    fig = px.pie(df_portfolio, values='Value', names='Asset', title="Portfolio Allocation")
    st.plotly_chart(fig, use_container_width=True)

    # Holdings table
    st.subheader("Holdings Details")
    st.dataframe(df_portfolio.style.format({
        'Value': '${:,.0f}',
        'Weight': '{:.1f}%',
        'Change': '{:+.1f}%'
    }))

    # Rebalancing suggestions
    st.subheader("AI Rebalancing Suggestions")

    suggestions = [
        {"action": "Increase MSFT allocation by 5%", "reason": "Strong AI growth potential"},
        {"action": "Reduce TSLA exposure by 3%", "reason": "High volatility detected"},
        {"action": "Add defensive bonds +2%", "reason": "Market uncertainty"}
    ]

    for suggestion in suggestions:
        st.info(f"**{suggestion['action']}**: {suggestion['reason']}")

elif page == "Document Analysis":
    st.header("üìÑ Document Analysis")

    # Document upload
    uploaded_file = st.file_uploader("Upload Financial Document", type=['pdf', 'txt', 'docx'])

    if uploaded_file is not None:
        st.success(f"File {uploaded_file.name} uploaded successfully!")

        # Document analysis
        question = st.text_input("Ask a question about the document:")

        if st.button("Analyze Document", type="primary") and question:
            if BACKEND_RUNNING:
                with st.spinner("Analyzing document..."):
                    result = client.analyze_document(question)

                    if result:
                        st.subheader("Analysis Result")
                        st.write(result.get('answer', 'No answer found'))

                        if 'sources' in result:
                            st.subheader("Source References")
                            for source in result['sources']:
                                st.write(f"- {source.get('title', 'Unknown')}: {source.get('content', '')[:200]}...")
                    else:
                        st.error("Analysis failed")
            else:
                st.warning("Please start the backend first")

    # Sample questions
    st.subheader("Sample Questions")
    sample_questions = [
        "What is the company's revenue growth rate?",
        "Are there any risk factors mentioned?",
        "What is the dividend yield?",
        "How does the company compare to competitors?"
    ]

    for q in sample_questions:
        if st.button(q):
            st.text_input("Question", value=q, key=q)

elif page == "Social Network":
    st.header("üë• Investor Social Network")

    # User profile
    col1, col2 = st.columns([1, 3])
    with col1:
        st.image("https://via.placeholder.com/100", caption="Your Avatar")
    with col2:
        st.subheader("John Investor")
        st.write("Experienced trader with 5+ years in markets")
        st.write("üèÜ Top 10% performer this quarter")

    # Social feed
    st.subheader("Community Feed")

    if BACKEND_RUNNING:
        user_id = "john_investor"
        feed = client.get_social_feed(user_id)

        if feed and 'posts' in feed:
            for post in feed['posts']:
                with st.container():
                    st.write(f"**{post.get('user', 'Anonymous')}**")
                    st.write(post.get('content', ''))
                    st.write(f"‚ù§Ô∏è {post.get('likes', 0)} likes")
                    st.divider()
        else:
            # Sample posts
            posts = [
                {"user": "Sarah Trader", "content": "Bullish on tech stocks for Q4!", "likes": 15},
                {"user": "Mike Analyst", "content": "Market analysis: Expect volatility next week", "likes": 8},
                {"user": "Crypto King", "content": "Bitcoin showing strong support at $60k", "likes": 23}
            ]

            for post in posts:
                with st.container():
                    st.write(f"**{post['user']}**")
                    st.write(post['content'])
                    st.write(f"‚ù§Ô∏è {post['likes']} likes")
                    st.divider()
    else:
        st.warning("Start backend to load social feed")

    # Create post
    st.subheader("Share Your Insights")
    new_post = st.text_area("What's on your mind?")
    if st.button("Post", type="primary") and new_post:
        st.success("Post shared! (Demo - not actually posted)")

elif page == "Investment Ladder":
    st.header("üèÜ Investment Ladder")

    # Current progress
    user_id = st.text_input("Enter User ID", value="demo_user")

    if st.button("Check Progress"):
        if BACKEND_RUNNING:
            progress = client.get_ladder_progress(user_id)

            if progress:
                st.subheader("Your Progress")

                # Progress bar
                progress_pct = progress.get('progress', 0) * 100
                st.progress(progress_pct / 100)
                st.write(f"Level {progress.get('current_level', 1)} - {progress_pct:.1f}% to next level")

                # Requirements
                reqs = progress.get('next_level_requirements', {})
                st.subheader("Next Level Requirements")
                for key, value in reqs.items():
                    st.write(f"- {key.replace('_', ' ').title()}: {value}")
            else:
                # Demo data
                st.subheader("Your Progress")
                st.progress(0.65)
                st.write("Level 2 - 65% to Level 3")

                st.subheader("Next Level Requirements")
                st.write("- Investments needed: 5")
                st.write("- Minimum portfolio value: $25,000")
        else:
            st.warning("Start backend to check progress")

    # Ladder visualization
    st.subheader("Investment Ladder")

    levels = [
        {"level": 1, "name": "Beginner", "requirement": "Open account"},
        {"level": 2, "name": "Active Trader", "requirement": "10 trades"},
        {"level": 3, "name": "Portfolio Builder", "requirement": "$25k portfolio"},
        {"level": 4, "name": "Expert", "requirement": "Consistent returns"},
        {"level": 5, "name": "Master", "requirement": "Mentor others"}
    ]

    for level in levels:
        if level['level'] <= 2:  # Demo progress
            st.success(f"‚úÖ Level {level['level']}: {level['name']} - {level['requirement']}")
        else:
            st.info(f"üîí Level {level['level']}: {level['name']} - {level['requirement']}")

elif page == "Settings":
    st.header("‚öôÔ∏è Settings")

    st.subheader("API Configuration")
    st.text_input("Kronos API URL", value="{{ kronos_endpoint }}")
    st.text_input("DocsGPT API URL", value="{{ docsgpt_endpoint }}")
    st.text_input("Goose API URL", value="{{ goose_endpoint }}")

    st.subheader("Display Preferences")
    theme = st.selectbox("Theme", ["Light", "Dark", "Auto"])
    chart_style = st.selectbox("Chart Style", ["Default", "Minimal", "Detailed"])

    st.subheader("Risk Preferences")
    risk_tolerance = st.slider("Risk Tolerance", 1, 10, 5)
    st.write(f"Current risk tolerance: {risk_tolerance}/10")

    if st.button("Save Settings"):
        st.success("Settings saved! (Demo)")

# Footer
st.markdown("---")
st.markdown("Built with ‚ù§Ô∏è using FinAI Hub | Powered by Kronos AI, DocsGPT, and advanced analytics")

if __name__ == "__main__":
    # Auto-start backend if not running
    if not BACKEND_RUNNING:
        start_backend()
```
