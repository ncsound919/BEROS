project 1\AutoCoder-Forge-Basic\templates\docsgpt_query_endpoint.py.j2
"""
DocsGPT Query API Router for FinAI Hub
Generated by AutoCoder

Template variables:
  - endpoint_prefix: str (API prefix)
  - vector_store_path: str (path to vector store)
"""

from fastapi import APIRouter, HTTPException
from pydantic import BaseModel
from typing import List, Dict, Any, Optional
import requests
import os

# Assuming DocsGPT API is running locally or accessible
DOCSGPT_API_URL = os.getenv("DOCSGPT_API_URL", "http://localhost:5001")

router = APIRouter(prefix="{{ endpoint_prefix }}", tags=["docsgpt"])

class QueryRequest(BaseModel):
    question: str
    document_id: Optional[str] = None
    history: Optional[List[Dict[str, str]]] = None
    max_tokens: int = 150

class QueryResponse(BaseModel):
    answer: str
    sources: List[Dict[str, Any]]
    confidence: float

@router.post("/query", response_model=QueryResponse)
async def query_documents(request: QueryRequest):
    try:
        # Prepare payload for DocsGPT API
        payload = {
            "question": request.question,
            "max_tokens": request.max_tokens,
        }
        if request.document_id:
            payload["document_id"] = request.document_id
        if request.history:
            payload["history"] = request.history

        # Make request to DocsGPT API
        response = requests.post(f"{DOCSGPT_API_URL}/api/answer", json=payload, timeout=30)
        response.raise_for_status()

        data = response.json()

        # Format response
        sources = []
        if "sources" in data:
            sources = data["sources"]

        confidence = data.get("confidence", 0.5)

        return QueryResponse(
            answer=data.get("answer", "No answer available"),
            sources=sources,
            confidence=confidence
        )

    except requests.RequestException as e:
        raise HTTPException(status_code=503, detail=f"DocsGPT API unavailable: {str(e)}")
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"Query failed: {str(e)}")

@router.get("/documents")
async def list_documents():
    try:
        response = requests.get(f"{DOCSGPT_API_URL}/api/documents", timeout=10)
        response.raise_for_status()
        return response.json()
    except requests.RequestException as e:
        raise HTTPException(status_code=503, detail=f"DocsGPT API unavailable: {str(e)}")

@router.post("/upload")
async def upload_document(file: UploadFile = File(...)):
    try:
        files = {"file": (file.filename, file.file, file.content_type)}
        response = requests.post(f"{DOCSGPT_API_URL}/api/upload", files=files, timeout=60)
        response.raise_for_status()
        return response.json()
    except requests.RequestException as e:
        raise HTTPException(status_code=503, detail=f"Upload failed: {str(e)}")

@router.get("/status")
async def get_status():
    try:
        response = requests.get(f"{DOCSGPT_API_URL}/api/status", timeout=5)
        return {"available": response.status_code == 200}
    except:
        return {"available": False}
