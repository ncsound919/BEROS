"""
conftest.py - pytest fixtures for AetherDesk backend tests
Generated by AutoCoder Marathon Build

Template variables:
  - use_fakeredis: bool (default True)
  - create_test_client: bool (default True)
"""

import pytest
{% if use_fakeredis %}
import fakeredis
{% endif %}
{% if create_test_client %}
from fastapi.testclient import TestClient
from apps.api.main import app
{% endif %}
import json
from typing import Generator, Dict, Any


{% if use_fakeredis %}
@pytest.fixture
def redis_client():
    """Provide a fake Redis client for testing."""
    client = fakeredis.FakeStrictRedis(decode_responses=True)
    yield client
    client.flushall()


@pytest.fixture
def mock_redis_app(redis_client):
    """Provide FastAPI app with mocked Redis."""
    app.state.redis = redis_client
    yield app
    app.state.redis = None
{% endif %}


{% if create_test_client %}
@pytest.fixture
def test_client({% if use_fakeredis %}mock_redis_app{% endif %}) -> Generator[TestClient, None, None]:
    """Provide TestClient for FastAPI application."""
    with TestClient({% if use_fakeredis %}mock_redis_app{% else %}app{% endif %}) as client:
        yield client
{% endif %}


@pytest.fixture
def sample_session() -> Dict[str, Any]:
    """Provide sample session data for testing."""
    return {
        "session_id": "test_session_001",
        "protocol_id": "billing_invoice_v1",
        "node": "start",
        "fields": {
            "invoice_id": "INV123456",
            "zip": "12345"
        },
        "transcript": [
            {"from": "user", "text": "I need invoice help", "ts": 1609459200},
            {"from": "system", "text": "Please enter invoice ID", "ts": 1609459210}
        ],
        "route_key": "billing:invoice"
    }


@pytest.fixture
def sample_queue_item() -> Dict[str, Any]:
    """Provide sample queue item for testing."""
    return {
        "session_id": "test_queue_001",
        "protocol_id": "pharmacy_refill_v1",
        "preview": "Rx refill request",
        "queue": "general",
        "created_ts": 1609459200
    }


@pytest.fixture
def sample_protocol() -> Dict[str, Any]:
    """Provide sample protocol definition for testing."""
    return {
        "nodes": {
            "start": {
                "prompt": "Please enter your order ID",
                "field": "order_id",
                "validate": "^[A-Z0-9]{8,12}$",
                "next": "ask_zip"
            },
            "ask_zip": {
                "prompt": "Enter your ZIP code",
                "field": "zip",
                "validate": "^[0-9]{5}$",
                "next": "lookup_order"
            },
            "lookup_order": {
                "action": "lookup_order_status",
                "on_ok": "show_status",
                "on_fail": "agent_handoff"
            },
            "show_status": {
                "prompt": "Order status: pending",
                "options": [
                    "ok:end",
                    "agent:agent_handoff"
                ]
            },
            "agent_handoff": {
                "action": "handoff"
            },
            "end": {
                "action": "complete"
            }
        }
    }


@pytest.fixture(autouse=True)
def reset_state():
    """Reset any global state between tests."""
    yield
    # Cleanup after each test if needed


@pytest.fixture
def mock_twilio_response():
    """Mock Twilio TwiML response for testing."""
    return """<?xml version="1.0" encoding="UTF-8"?>
<Response>
    <Message>Test message</Message>
</Response>"""
