#!/usr/bin/env python3
"""
FinAI Hub EXE Build Script
Generated by AutoCoder

Template variables:
  - app_name: str (name of the app)
  - main_script: str (main Streamlit script)
  - backend_script: str (backend FastAPI script)
  - output_dir: str (output directory)
  - icon_path: str (optional icon path)
"""

import PyInstaller.__main__
import os
import sys
import shutil
from pathlib import Path

def build_exe():
    """Build FinAI Hub as standalone executable"""

    # Get the directory of this script
    script_dir = Path(__file__).parent

    # Main Streamlit app
    main_script = script_dir / "{{ main_script }}"

    # Backend script
    backend_script = script_dir / "{{ backend_script }}"

    # Output directory
    output_dir = script_dir / "{{ output_dir }}"

    # Clean previous build
    if output_dir.exists():
        shutil.rmtree(output_dir)

    # PyInstaller arguments
    args = [
        '--onefile',  # Single executable file
        '--windowed',  # No console window (for GUI apps)
        '--name={{ app_name }}',
        '--distpath={{ output_dir }}',
        '--workpath=temp_build',
        '--specpath=temp_build',
        # Include necessary packages
        '--hidden-import=streamlit',
        '--hidden-import=fastapi',
        '--hidden-import=uvicorn',
        '--hidden-import=plotly',
        '--hidden-import=pandas',
        '--hidden-import=numpy',
        '--hidden-import=torch',
        '--hidden-import=transformers',
        '--hidden-import=requests',
        '--hidden-import=pydantic',
        # Include data files
        '--add-data=finai_backend.py;.',
        # Backend will run in separate process
    ]

    # Add icon if specified
    {% if icon_path %}
    if os.path.exists("{{ icon_path }}"):
        args.append('--icon={{ icon_path }}')
    {% endif %}

    # Add main script
    args.append(str(main_script))

    print("Building FinAI Hub executable...")
    print(f"Main script: {main_script}")
    print(f"Output directory: {output_dir}")
    print(f"Arguments: {args}")

    # Run PyInstaller
    try:
        PyInstaller.__main__.run(args)

        # Check if exe was created
        exe_path = output_dir / "{{ app_name }}.exe"
        if exe_path.exists():
            print(f"‚úÖ Success! Executable created at: {exe_path}")
            print(f"File size: {exe_path.stat().st_size / (1024*1024):.2f} MB")

            # Create a simple launcher script
            launcher_script = output_dir / "run_finai_hub.bat"
            with open(launcher_script, 'w') as f:
                f.write(f'@echo off\n')
                f.write(f'title FinAI Hub\n')
                f.write(f'echo Starting FinAI Hub...\n')
                f.write(f'"{exe_path}"\n')
                f.write(f'pause\n')

            print(f"‚úÖ Launcher script created: {launcher_script}")

        else:
            print("‚ùå Error: Executable was not created")
            return False

    except Exception as e:
        print(f"‚ùå Build failed: {e}")
        return False

    # Clean up temp files
    try:
        shutil.rmtree('temp_build')
        spec_file = script_dir / "{{ app_name }}.spec"
        if spec_file.exists():
            os.remove(spec_file)
        print("‚úÖ Cleanup completed")
    except:
        pass

    return True

def check_requirements():
    """Check if required packages are installed"""
    required_packages = [
        'streamlit',
        'fastapi',
        'uvicorn',
        'plotly',
        'pandas',
        'numpy',
        'torch',
        'transformers',
        'requests',
        'pydantic',
        'pyinstaller'
    ]

    missing = []
    for package in required_packages:
        try:
            __import__(package.replace('-', '_'))
        except ImportError:
            missing.append(package)

    if missing:
        print("‚ùå Missing required packages:")
        for pkg in missing:
            print(f"  - {pkg}")
        print("\nInstall with: pip install " + " ".join(missing))
        return False

    print("‚úÖ All required packages are installed")
    return True

if __name__ == "__main__":
    print("FinAI Hub EXE Builder")
    print("=" * 50)

    # Check requirements
    if not check_requirements():
        sys.exit(1)

    # Build the executable
    success = build_exe()

    if success:
        print("\nüéâ Build completed successfully!")
        print("You can now run FinAI_Hub.exe from the dist directory")
        print("\nNote: The executable includes both frontend and backend.")
        print("Make sure all required model files and data are accessible.")
    else:
        print("\n‚ùå Build failed!")
        sys.exit(1)
